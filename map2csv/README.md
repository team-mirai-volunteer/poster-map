# 地図画像⇔緯度経度 対応マークツール

地図画像上で座標対応付け（画像座標と緯度経度）をインタラクティブに行い、CSVとしてダウンロードできるWebアプリケーションです。

## 🚀 機能概要

- **Streamlit Webインターフェース**: 直感的な地図画像アップロードと座標マーキング
- **座標対応付け**: 画像座標と実世界の緯度経度の対応関係を設定
- **アフィン変換**: 2点以上の対応点から自動的に座標変換を計算
- **インタラクティブマーキング**: 画像上のクリックで座標を取得し、番号付きマーカーを配置
- **CSV出力**: 番号、緯度、経度の情報をCSV形式でダウンロード
- **Docker対応**: コンテナ化による簡単なデプロイメント
- **Cloud Run対応**: Google Cloud Runでの本番運用

## 📦 ディレクトリ構成

```
map2csv/
├── app/
│   └── streamlit_app.py        # メインのStreamlitアプリケーション
├── Dockerfile                  # Docker設定
├── Makefile                   # デプロイメント用コマンド
├── requirements.txt           # Python依存関係
├── .dockerignore             # Docker除外ファイル
├── .gitignore               # Git除外ファイル
└── README.md                # このファイル
```

## 🛠️ ローカル開発環境のセットアップ

### 1. 依存関係のインストール

```bash
cd map2csv
pip install -r requirements.txt
```

### 2. アプリケーションの起動

```bash
streamlit run app/streamlit_app.py
```

アプリケーションは [http://localhost:8501](http://localhost:8501) でアクセス可能になります。

## 🐳 Docker での実行

### ローカルでのビルドと実行

```bash
# Dockerイメージのビルド
make build

# ローカルでの実行
make run
```

## ☁️ Google Cloud Run へのデプロイ

### 前提条件

- Google Cloud SDKがインストールされていること
- Google Cloud プロジェクトが設定されていること
- Artifact Registryが有効になっていること

### デプロイの実行

```bash
make deploy
```

## 📄 使用方法

### 1. 地図画像の準備

JPG、PNG、JPEG形式の地図画像を準備してください。

### 2. Webアプリケーションでの処理

1. 地図画像をアップロード
2. **位置合わせフェーズ**:
   - 画像上の2点以上をクリック
   - 各点に対応する実際の緯度経度を入力（例: 35.6,139.7）
   - 「位置合わせ完了」ボタンをクリック
3. **マーキングフェーズ**:
   - 画像上の任意の場所をクリック
   - 番号を入力してマーカーを追加
   - 自動的に緯度経度が計算される
4. 結果をCSVファイルとしてダウンロード

### 3. 出力形式

処理後のCSVは以下の形式で出力されます：

```csv
番号,緯度,経度
1,35.677349,139.774074
2,35.675209,139.772753
```

## ⚙️ 技術仕様

### 座標変換アルゴリズム

- **アフィン変換**: 2点の対応関係から回転、スケール、平行移動を計算
- **倍精度浮動小数点**: 緯度経度計算にnp.float64を使用し、数値精度を向上
- **リアルタイム変換**: クリック座標を即座に緯度経度に変換

### 依存関係

- **Streamlit**: Webアプリケーションフレームワーク
- **NumPy**: 数値計算ライブラリ
- **Pillow**: 画像処理ライブラリ
- **OpenCV**: コンピュータビジョンライブラリ
- **streamlit_image_coordinates**: 画像上のクリック座標取得

## 🔒 セキュリティ

- **外部API不要**: インターネット接続なしでも動作
- **ローカル処理**: 画像データはローカルで処理され、外部に送信されない
- **コンテナ化**: Dockerによる分離された実行環境

## 📌 注意事項

- 座標変換の精度は対応点の選択精度に依存します
- 大きな画像ファイルは自動的にリサイズされます（最大辺1500px）
- 処理中はブラウザを閉じないでください

## 🛠️ トラブルシューティング

### よくある問題

1. **画像が表示されない**: サポートされている形式（PNG、JPG、JPEG）か確認
2. **座標変換が不正確**: 対応点をより正確に選択し直してください
3. **メモリエラー**: 大量データ処理時はCloud Runのメモリ設定を増加

### ログの確認

```bash
# Cloud Runのログを確認
gcloud logs read --service=webtool-map2csv --limit=50
```

## 📜 ライセンス

このプロジェクトは[GPL-3.0 license](https://github.com/team-mirai-volunteer/poster-map/blob/main/LICENSE)の下で公開されています。
